name: ci
on:
  push:
    branches: [master, dev]
  pull_request:

  workflow_dispatch:
    inputs:
      web_port:
        description: "Host port for web"
        default: "8080"
        required: false
      api_port:
        description: "Host port for API"
        default: "3001"
        required: false

permissions:
  contents: read
  packages: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test_ports:
    runs-on: ubuntu-latest

    outputs:
      web_port: ${{ steps.export_ports.outputs.web_port }}
      api_port: ${{ steps.export_ports.outputs.api_port }}

    steps:
      - uses: actions/checkout@v4

      - name: Normalize inputs -> $GITHUB_ENV
        shell: bash
        run: |
          WEB_PORT="${{ inputs.web_port }}"
          API_PORT="${{ inputs.api_port }}"
          : "${WEB_PORT:=8080}"
          : "${API_PORT:=3001}"
          echo "WEB_PORT=$WEB_PORT" >> "$GITHUB_ENV"
          echo "API_PORT=$API_PORT" >> "$GITHUB_ENV"

        #for other job access (if they want to be spoiled a lil)
      - name: Export ports as outputs
        id: export_ports
        shell: bash
        run: |
          echo "web_port=${WEB_PORT}" >> "$GITHUB_OUTPUT"
          echo "api_port=${API_PORT}" >> "$GITHUB_OUTPUT"

      - name: Show resolved ports (debug)
        run: |
          echo "WEB_PORT=$WEB_PORT"
          echo "API_PORT=$API_PORT"

      - name: Compose override for ports
        run: |
          cat > compose.ports.override.yml <<'YAML'
          services:
            web:
              ports:
                - "${WEB_PORT}:80"
            api:
              ports:
                - "${API_PORT}:3001"
          YAML
          echo "---- compose.ports.override.yml ----"
          cat compose.ports.override.yml

      - name: Show merged config (with override)
        run: |
          docker compose \
            -f compose.base.yml \
            -f compose.prod.yml \
            -f compose.ports.override.yml \
            config  

      - name: Up and wait (with override)
        run: |
          docker compose \
            -f compose.base.yml \
            -f compose.prod.yml \
            -f compose.ports.override.yml \
            up -d --wait

      - name: Smoke checks (both ports)
        run: |
          set -euxo pipefail
          curl -sfI "http://localhost:${WEB_PORT}/" > /dev/null
          curl -sfI "http://localhost:${WEB_PORT}/api/health" > /dev/null
          curl -sfI "http://localhost:${API_PORT}/health" > /dev/null

      - name: Down
        if: always()
        run: |
          docker compose \
            -f compose.base.yml \
            -f compose.prod.yml \
            -f compose.ports.override.yml \
            down -v

  build_api:
    runs-on: ubuntu-latest
    steps:

      - name: Lowercase owner
        shell: bash
        run: echo "OWNER_LC=${OWNER@L}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Checkout code
        uses: actions/checkout@v4
      - run: echo "Using ports -> web:$WEB_PORT api:$API_PORT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: build and push API
        uses: docker/build-push-action@v6
        id: build_api
        with:
          context: ./server
          tags: ghcr.io/${{ env.OWNER_LC }}/bookscrude-api:sha-${{ github.sha }}
          push: true
          cache-from: type=gha
          cache-to: type=gha, mode=max

      - name: Trivy scan API
        uses: aquasecurity/trivy-action@0.28.0
        env:
          TRIVY_USERNAME: ${{ github.actor }}
          TRIVY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        with:
          scan-type: image
          image-ref: ghcr.io/${{ env.OWNER_LC }}/bookscrude-api:@${{ steps.build_api.outputs.digest }}
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true
          exit-code: "1"

  build_web:
    runs-on: ubuntu-latest
    steps:

      - name: Lowercase owner
        shell: bash
        run: echo "OWNER_LC=${OWNER@L}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push web
        id: build_web
        uses: docker/build-push-action@v6
        with:
          context: ./client
          file: ./client/Dockerfile.nginx
          tags: ghcr.io/${{ env.OWNER_LC }}/bookscrude-web:sha-${{ github.sha }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Docker metadata
        id: meta #meta irony
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.OWNER_LC }}/bookscrude-web
          tags: type=sha
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
